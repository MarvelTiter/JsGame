<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>记账器</title>
    <link rel="stylesheet" href="//unpkg.com/element-plus/dist/index.css" />
    <script src="https://unpkg.com/vue@next"></script>
    <script src="https://unpkg.com/element-plus"></script>
    <style>
        .head {
            display: flex;
            flex-wrap: wrap;
        }
        
        .head .el-badge {
            margin: 5px 20px;
            text-align: center;
        }
        
        .btn {
            width: 100%;
        }
        
        .records {
            display: flex;
            flex-direction: column;
        }
        
        .records .el-card {
            margin-bottom: 10px;
        }
        
        .add {
            position: fixed;
            bottom: 3vh;
            width: 100vw;
            text-align: center;
        }
        
        .record-item .el-button+.el-button {
            margin-left: 6px;
        }
        
        .member-name {
            display: inherit;
        }
        
        .icon {
            width: 14px;
        }
    </style>
</head>

<body>
    <div id="app">
        <div class="head">
            <el-badge :value="calcTotal(m)" v-for="(m,i) of members" @click="setBanker(m)">
                <el-tag class="btn" size="large" :type="m == banker ? 'warning':''">
                    <svg class="icon" v-if="m == banker" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" data-v-042ca774="">
                        <path fill="currentColor"
                            d="M480 896V702.08A256.256 256.256 0 01264.064 512h-32.64a96 96 0 01-91.968-68.416L93.632 290.88a76.8 76.8 0 0173.6-98.88H256V96a32 32 0 0132-32h448a32 32 0 0132 32v96h88.768a76.8 76.8 0 0173.6 98.88L884.48 443.52A96 96 0 01792.576 512h-32.64A256.256 256.256 0 01544 702.08V896h128a32 32 0 110 64H352a32 32 0 110-64h128zm224-448V128H320v320a192 192 0 10384 0zm64 0h24.576a32 32 0 0030.656-22.784l45.824-152.768A12.8 12.8 0 00856.768 256H768v192zm-512 0V256h-88.768a12.8 12.8 0 00-12.288 16.448l45.824 152.768A32 32 0 00231.424 448H256z">
                        </path>
                    </svg> <span class="member-name">{{m}}</span>
                </el-tag>
            </el-badge>
            <el-badge>
                <el-button type="primary" @click="addMember">
                    +
                </el-button>
            </el-badge>
            <el-badge>
                <el-button type="danger" @click="reset">
                    重置
                </el-button>
            </el-badge>
        </div>
        <el-divider></el-divider>
        <div class="records">
            <el-card v-for="r of records">
                <el-space spacer="|" wrap>
                    <div>
                        <span>第{{r.sequence}}局</span>
                    </div>
                    <div v-if="r.banker != ''">
                        <span>庄家:{{r.banker}}</span>
                    </div>
                    <div v-for="i of r.members">
                        <el-tag :type="calcType(i.value)">
                            {{i.name}} | {{i.value}}
                        </el-tag>
                    </div>
                </el-space>
            </el-card>
        </div>
        <el-dialog v-model="memberDialog.visible" width="80%">
            <el-form>
                <el-form-item label="名字">
                    <el-input size="large" v-model="temp"></el-input>
                </el-form-item>
                <el-form-item>
                    <el-button style="width:100%" type="primary" @click="handleMemberAdd">添加</el-button>
                </el-form-item>
            </el-form>
        </el-dialog>
        <el-dialog v-model="recordDialog.visible" width="95%">
            <el-form label-position="top">
                <el-form-item v-for="m of newRecord" class="record-item">
                    <template v-slot:label>
                        <span v-if="m.name == banker" style="color:red;font-size:18px;">庄家 | </span>
                        <span>{{m.name}} : {{m.value}}</span>
                        <el-button @click="allKill" v-if="m.name == banker" style="margin-left: 10px;" type="danger">通杀
                        </el-button>
                    </template>
                    <el-button type="danger" @click="updateValue(m, -3)">-3</el-button>
                    <el-button type="danger" @click="updateValue(m, -2)">-2</el-button>
                    <el-button type="danger" @click="updateValue(m, -1)">-1</el-button>
                    <el-button type="success" @click="updateValue(m, 1)">+1</el-button>
                    <el-button type="success" @click="updateValue(m, 2)">+2</el-button>
                    <el-button type="success" @click="updateValue(m, 3)">+3</el-button>
                </el-form-item>
                <el-form-item>
                    <el-button style="width:100%" type="primary" @click="handleRecordAdd">添加</el-button>
                </el-form-item>
            </el-form>
        </el-dialog>
        <div class="add">
            <el-button type="primary" @click="addRecord" @click="addRecord">记录</el-button>
        </div>
    </div>
</body>
<script>
    const app = Vue.createApp({
        data() {
            return {
                members: [],
                records: [],
                newRecord: [],
                memberDialog: {
                    visible: false
                },
                recordDialog: {
                    visible: false
                },
                temp: '',
                banker: '',
            }
        },
        mounted() {
            console.log('mounted');
            try {
                let mems = localStorage.getItem('members')
                this.members = JSON.parse(mems) || []
                let recs = localStorage.getItem('records')
                this.records = JSON.parse(recs) || []
                console.log(this.members, this.records);
            } catch (error) {
                this.members = []
                this.records = []
            }
        },
        methods: {
            calcType(v) {
                if (v > 0) {
                    return 'success'
                } else if (v < 0) {
                    return 'danger'
                } else {
                    return 'info'
                }
            },
            addMember() {
                this.memberDialog.visible = true
            },
            addRecord() {
                this.newRecord = []
                for (const e of this.members) {
                    this.newRecord.push({
                        name: e,
                        value: 0
                    })
                }
                this.recordDialog.visible = true
            },
            reset() {
                if (!confirm('将清空所有记录！')) {
                    return
                }
                this.members = []
                this.records = []
                localStorage.setItem('members', '')
                localStorage.setItem('records', '')

            },
            handleMemberAdd() {
                if (this.members.length > 0 && this.members.indexOf(this.temp) > -1) {
                    this.$message.error('重复')
                    return
                }
                this.members.push(this.temp)
                this.memberDialog.visible = false
                this.temp = ''
                localStorage.setItem('members', JSON.stringify(this.members))
            },
            handleRecordAdd() {
                let total = 0
                for (const m of this.newRecord) {
                    total += m.value
                }
                if (total == 0) {
                    let nr = {
                        banker: this.banker,
                        sequence: this.records.length + 1,
                        members: this.newRecord
                    }
                    this.records.unshift(nr)
                    this.recordDialog.visible = false
                    localStorage.setItem('records', JSON.stringify(this.records))
                } else {
                    this.$message.error('总数异常')
                }
            },
            calcTotal(m) {
                let total = 0
                for (const r of this.records) {
                    for (const mem of r.members) {
                        if (mem.name == m) {
                            total += mem.value
                        }
                    }
                }
                return total
            },
            updateValue(mem, v) {
                mem.value += v
                if (!this.banker || this.banker == mem.name) return
                let b = this.newRecord.filter(m => m.name == this.banker)[0]
                let lost = 0
                for (const m of this.newRecord) {
                    if (m.name == this.banker) continue
                    lost += m.value
                }
                b.value = 0 - lost
            },
            setBanker(m) {
                if (this.banker == m) {
                    this.banker = ''
                } else {
                    this.banker = m
                }
            },
            allKill() {
                let b = this.newRecord.filter(m => m.name == this.banker)[0]
                let lost = 0
                for (const m of this.newRecord) {
                    if (m.name == this.banker) continue
                    m.value -= b.value
                    lost -= b.value
                    console.log(m);
                }
                b.value = 0 - lost
            }
        }
    })
    app.use(ElementPlus)
    app.mount('#app')
</script>

</html>

<!-- {
    sequence: 0,
    members: [{
        name: "林",
        value: 2
    }, {
        name: "林",
        value: 0
    }, {
        name: "林",
        value: -2
    }]
}, {
    sequence: 1,
    members: [{
        name: "林",
        value: 2
    }, {
        name: "林",
        value: 0
    }, {
        name: "林",
        value: -2
    }]
} -->